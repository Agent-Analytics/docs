# Agent Analytics — Full API Reference

> Web analytics platform with an HTTP API that AI agents can query.

Base URL: `https://api.agentanalytics.sh`

---

## Getting Started

1. **Sign up** at [app.agentanalytics.sh](https://app.agentanalytics.sh) and get your API key
2. **Give the API key to your AI agent** — it can do everything from here: create projects, add tracking, and query stats
3. **Your agent creates a project:**
   ```bash
   curl -X POST "https://api.agentanalytics.sh/projects" \
     -H "X-API-Key: aak_..." \
     -H "Content-Type: application/json" \
     -d '{"name": "my-site"}'
   ```
4. **Your agent adds the tracking snippet** (returned in the response above):
   ```html
   <script src="https://api.agentanalytics.sh/tracker.js"
           data-project="my-site" data-token="aat_..."></script>
   ```
5. **Your agent queries stats:**
   ```bash
   curl "https://api.agentanalytics.sh/stats?project=my-site&since=7d" \
     -H "X-API-Key: aak_..."
   ```

## Authentication

### API Key (`aak_*`) — for reading data & project management
Passed via the `X-API-Key` header or `?key=` query parameter. **Keep this secret.**
Used for all read endpoints (`/stats`, `/events`, `/query`, etc.) and project management (`/projects`, `/account`).

### Project Token (`aat_*`) — for event ingestion
Passed in the request body as `token`. This is a **public** identifier embedded in your site's HTML — not a secret.
Used only for `POST /track` and `POST /track/batch`.

## MCP Server

Connect Agent Analytics directly to Claude, Cursor, or any MCP-compatible AI client.

**URL:** `https://mcp.agentanalytics.sh/mcp`

### Add to Claude Desktop / claude.ai
Click Settings > Connectors > Add > Custom and enter `https://mcp.agentanalytics.sh/mcp`. Sign in with GitHub or Google (must match your Agent Analytics account).

### Add to Claude Code
```bash
claude mcp add agent-analytics --transport http https://mcp.agentanalytics.sh/mcp
```

### MCP Tools

| Tool | Description |
|------|-------------|
| `list_projects` | List all your projects |
| `create_project` | Create a new project (returns tracker snippet) |
| `analytics_overview` | Time series chart + KPIs (events, users) over N days |
| `analytics_insights` | Period-over-period comparison with trend |
| `analytics_breakdown` | Top property values (pages, referrers, UTM sources) |
| `analytics_pages` | Entry/exit page stats with bounce rate |
| `analytics_sessions` | Session duration histogram |
| `analytics_heatmap` | Day-of-week x hour traffic grid |
| `properties` | Discover event names and property keys |
| `properties_received` | Property keys by event name (sampled) |
| `sessions` | List individual session records |
| `list_experiments` | List A/B experiments |
| `create_experiment` | Create an A/B experiment |
| `get_experiment` | Get experiment details with results |
| `update_experiment` | Update experiment status (pause/resume/complete) |
| `delete_experiment` | Delete an experiment |

## CLI

You can also use the CLI. Every CLI command maps to an API endpoint.

```bash
npx @agent-analytics/cli stats my-site          # GET /stats?project=my-site
npx @agent-analytics/cli events my-site          # GET /events?project=my-site
npx @agent-analytics/cli query --project my-site # POST /query
npx @agent-analytics/cli projects                # GET /projects
```

## Rate Limits

| Tier | Requests/min | Event Limit | Data Retention |
|------|-------------|-------------|----------------|
| Free | 10 | 100 lifetime | 7 days |
| Pro  | 1,000 | Unlimited | 365 days |

## Error Format

All errors return JSON:
```json
{ "error": "AUTH_REQUIRED", "message": "API key required" }
```

Error codes: `AUTH_REQUIRED`, `FORBIDDEN`, `PROJECT_REQUIRED`, `MISSING_FIELDS`, `RATE_LIMITED`, `INVALID_TOKEN`, `BATCH_TOO_LARGE`, `INVALID_METRIC`, `INVALID_GROUP_BY`, `INVALID_FILTER_OP`, `INVALID_PROPERTY_KEY`, `NOT_FOUND`.

---

## Endpoints

---

### POST /track

Track a single event. Called automatically by the `tracker.js` script — you don't call this directly.

**Auth:** Project token in request body

**Request body:**
```json
{
  "token": "aat_...",          // required — project token
  "event": "page_view",       // required — event name (max 256 chars)
  "properties": {             // optional — arbitrary key-value pairs (max 8KB JSON)
    "path": "/pricing",
    "referrer": "https://google.com",
    "browser": "Chrome",
    "os": "macOS"
  },
  "user_id": "usr_abc123",    // optional — anonymous user ID (max 256 chars)
  "session_id": "ses_xyz789", // optional — session ID (max 256 chars)
  "timestamp": 1706745600000  // optional — unix ms, defaults to now
}
```

The tracker auto-populates: `path`, `url`, `hostname`, `title`, `referrer`, `screen`, `browser`, `browser_version`, `os`, `device`, `language`, and `utm_*` params.

**Response:** `202 Accepted`
```json
{ "ok": true, "queued": true }
```

---

### POST /track/batch

Track up to 100 events in a single request. All events must use the same project token.

**Auth:** Project token in request body

**Request body:**
```json
{
  "events": [
    { "token": "aat_...", "event": "page_view", "properties": { "path": "/" } },
    { "token": "aat_...", "event": "page_view", "properties": { "path": "/about" } }
  ]
}
```

**Response:** `202 Accepted`
```json
{ "ok": true, "queued": true, "count": 2 }
```

---

### GET /stats

Aggregated stats overview with time series, top events, and session metrics.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `since` | no | Start date. ISO 8601 (`2025-01-01`) or shorthand (`7d`, `30d`). Default: 7 days ago |
| `groupBy` | no | Time series granularity: `hour`, `day`, `week`, `month`. Default: `day` |

**Example:**
```bash
curl "https://api.agentanalytics.sh/stats?project=my-site&since=7d" \
  -H "X-API-Key: aak_..."
```

**Response:**
```json
{
  "project": "my-site",
  "period": { "from": "2025-01-01", "to": "2025-01-07", "groupBy": "day" },
  "totals": { "unique_users": 142, "total_events": 1247 },
  "timeSeries": [
    { "bucket": "2025-01-01", "unique_users": 20, "total_events": 178 },
    ...
  ],
  "events": [
    { "event": "page_view", "count": 1100, "unique_users": 140 },
    ...
  ],
  "sessions": {
    "total_sessions": 200,
    "bounce_rate": 0.45,
    "avg_duration": 120000,
    "pages_per_session": 2.5,
    "sessions_per_user": 1.4
  }
}
```

---

### GET /events

Raw event log, newest first.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `event` | no | Filter by event name |
| `session_id` | no | Filter by session ID |
| `since` | no | Start date. Default: 7 days ago |
| `limit` | no | Max results (1-1000). Default: 100 |

**Example:**
```bash
curl "https://api.agentanalytics.sh/events?project=my-site&event=page_view&limit=50" \
  -H "X-API-Key: aak_..."
```

**Response:**
```json
{
  "project": "my-site",
  "events": [
    {
      "id": "evt_...",
      "project_id": "proj_...",
      "event": "page_view",
      "properties": { "path": "/pricing", "browser": "Chrome" },
      "user_id": "usr_abc123",
      "session_id": "ses_xyz789",
      "timestamp": 1706745600000,
      "date": "2025-01-31"
    }
  ]
}
```

---

### POST /query

Flexible analytics query with metrics, grouping, filtering, and ordering.

**Auth:** API key via `X-API-Key` header

**Request body:**
```json
{
  "project": "my-site",        // required
  "metrics": ["event_count", "unique_users"],  // default: ["event_count"]
  "group_by": ["date"],        // default: []
  "filters": [
    { "field": "event", "op": "eq", "value": "page_view" },
    { "field": "properties.browser", "op": "eq", "value": "Chrome" }
  ],
  "date_from": "2025-01-01",  // or "7d" shorthand
  "date_to": "2025-01-07",
  "order_by": "event_count",
  "order": "desc",
  "limit": 100
}
```

**Available metrics:** `event_count`, `unique_users`, `session_count`, `bounce_rate`, `avg_duration`

**Group by:** `event`, `date`, `user_id`, `session_id`

**Filter operators:** `eq`, `neq`, `gt`, `lt`, `gte`, `lte`

**Filterable fields:** `event`, `user_id`, `date`, and any `properties.*` field (e.g. `properties.path`, `properties.browser`)

**Response:**
```json
{
  "project": "my-site",
  "period": { "from": "2025-01-01", "to": "2025-01-07" },
  "metrics": ["event_count", "unique_users"],
  "group_by": ["date"],
  "rows": [
    { "date": "2025-01-01", "event_count": 178, "unique_users": 20 },
    ...
  ],
  "count": 7
}
```

---

### GET /properties

Discover event names and property keys from recent events.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `since` | no | Start date. Default: 7 days ago |

**Response:**
```json
{
  "project": "my-site",
  "events": [
    { "event": "page_view", "count": 1100, "unique_users": 140, "first_seen": "2025-01-01", "last_seen": "2025-01-07" }
  ],
  "property_keys": ["browser", "device", "hostname", "language", "os", "path", "referrer", "screen", "title", "url"]
}
```

---

### GET /properties/received

Property keys by event name, sampled from recent events.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `since` | no | Start date |
| `sample` | no | Number of events to sample (100-10000). Default: 5000 |

**Response:**
```json
{
  "project": "my-site",
  "sample_size": 5000,
  "since": "7d",
  "properties": [
    { "key": "path", "event": "page_view" },
    { "key": "browser", "event": "page_view" }
  ]
}
```

---

### GET /sessions

List individual session records.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `since` | no | Start date |
| `limit` | no | Max results (1-1000). Default: 100 |
| `user_id` | no | Filter by user ID |
| `is_bounce` | no | Filter by bounce status (0 or 1) |

**Response:**
```json
{
  "project": "my-site",
  "sessions": [
    {
      "session_id": "ses_...",
      "user_id": "usr_...",
      "project_id": "proj_...",
      "start_time": 1706745600000,
      "end_time": 1706745720000,
      "duration": 120000,
      "entry_page": "/",
      "exit_page": "/pricing",
      "event_count": 3,
      "is_bounce": 0,
      "date": "2025-01-31"
    }
  ]
}
```

---

### GET /breakdown

Top property values by count. Great for top pages, referrers, browsers, UTM sources.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `property` | yes | Property key to break down (e.g. `path`, `referrer`, `utm_source`) |
| `event` | no | Filter by event name |
| `since` | no | Start date |
| `limit` | no | Max values (1-1000). Default: 20 |

**Example:**
```bash
curl "https://api.agentanalytics.sh/breakdown?project=my-site&property=path&event=page_view" \
  -H "X-API-Key: aak_..."
```

**Response:**
```json
{
  "project": "my-site",
  "property": "path",
  "event": "page_view",
  "values": [
    { "value": "/pricing", "count": 342, "unique_users": 201 },
    { "value": "/", "count": 298, "unique_users": 180 }
  ],
  "total_events": 1247,
  "total_with_property": 1200
}
```

---

### GET /insights

Period-over-period comparison with trend indicator.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `period` | no | Comparison period: `1d`, `7d`, `14d`, `30d`, `90d`. Default: `7d` |

**Response:**
```json
{
  "project": "my-site",
  "current_period": { "from": "2025-01-01", "to": "2025-01-07" },
  "previous_period": { "from": "2024-12-25", "to": "2024-12-31" },
  "metrics": {
    "total_events": { "current": 1247, "previous": 1050, "change": 197, "change_pct": 19 },
    "unique_users": { "current": 142, "previous": 120, "change": 22, "change_pct": 18 },
    "total_sessions": { "current": 200, "previous": 170, "change": 30, "change_pct": 18 },
    "bounce_rate": { "current": 0.45, "previous": 0.50, "change": -0.05, "change_pct": -10 },
    "avg_duration": { "current": 120000, "previous": 100000, "change": 20000, "change_pct": 20 }
  },
  "trend": "growing"
}
```

---

### GET /pages

Entry and/or exit page stats with bounce rate and avg duration.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `type` | no | `entry`, `exit`, or `both`. Default: `entry` |
| `since` | no | Start date |
| `limit` | no | Max pages (1-1000). Default: 20 |

**Response:**
```json
{
  "project": "my-site",
  "entry_pages": [
    { "page": "/", "sessions": 100, "bounces": 45, "bounce_rate": 0.45, "avg_duration": 120000, "avg_events": 2.5 }
  ],
  "exit_pages": [
    { "page": "/pricing", "sessions": 80, "bounces": 30, "bounce_rate": 0.375, "avg_duration": 90000, "avg_events": 3.0 }
  ]
}
```

---

### GET /sessions/distribution

Session duration histogram with engagement metrics.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `since` | no | Start date |

**Response:**
```json
{
  "project": "my-site",
  "distribution": [
    { "bucket": "0s", "sessions": 45, "bounces": 45, "avg_events": 1.0, "pct": 22.5 },
    { "bucket": "1-10s", "sessions": 30, "bounces": 10, "avg_events": 1.5, "pct": 15.0 },
    { "bucket": "10-30s", "sessions": 25, "bounces": 5, "avg_events": 2.0, "pct": 12.5 },
    { "bucket": "30-60s", "sessions": 40, "bounces": 0, "avg_events": 3.0, "pct": 20.0 },
    { "bucket": "1-3m", "sessions": 35, "bounces": 0, "avg_events": 4.0, "pct": 17.5 },
    { "bucket": "3-10m", "sessions": 20, "bounces": 0, "avg_events": 6.0, "pct": 10.0 },
    { "bucket": "10m+", "sessions": 5, "bounces": 0, "avg_events": 10.0, "pct": 2.5 }
  ],
  "median_bucket": "30-60s",
  "engaged_pct": 50.0
}
```

---

### GET /heatmap

Day-of-week x hour-of-day traffic grid (UTC) with peak detection.

**Auth:** API key via `X-API-Key` header

**Parameters:**
| Param | Required | Description |
|-------|----------|-------------|
| `project` | yes | Project name |
| `since` | no | Start date |

**Response:**
```json
{
  "project": "my-site",
  "heatmap": [
    { "day": 1, "day_name": "Monday", "hour": 14, "events": 52, "users": 30 },
    ...
  ],
  "peak": { "day": 1, "day_name": "Monday", "hour": 14, "events": 52, "users": 30 },
  "busiest_day": "Monday",
  "busiest_hour": 14
}
```

---

### GET /projects

List all projects under your account.

**Auth:** API key via `X-API-Key` header

**Response:**
```json
{
  "projects": [
    {
      "id": "proj_...",
      "name": "my-site",
      "project_token": "aat_...",
      "allowed_origins": "*",
      "total_events": 1247,
      "total_reads": 50
    }
  ],
  "has_api_key": true,
  "project_limit": 2,
  "tier": "free"
}
```

---

### POST /projects

Create a new project. Returns a tracking snippet.

**Auth:** API key via `X-API-Key` header

**Request body:**
```json
{
  "name": "my-new-site",             // required — alphanumeric, hyphens, underscores, dots (max 64 chars)
  "allowed_origins": "https://example.com"  // optional — default "*"
}
```

**Response:** `201 Created`
```json
{
  "id": "proj_...",
  "name": "my-new-site",
  "project_token": "aat_...",
  "allowed_origins": "https://example.com",
  "snippet": "<script src=\"https://api.agentanalytics.sh/tracker.js\" data-project=\"my-new-site\" data-token=\"aat_...\"></script>",
  "api_example": "curl \"https://api.agentanalytics.sh/stats?project=my-new-site\" -H \"X-API-Key: aak_...\""
}
```

If the project already exists, returns `200` with `"existing": true`.

---

### GET /projects/{id}

Get a single project with today's usage stats.

**Auth:** API key via `X-API-Key` header

---

### PATCH /projects/{id}

Update a project's name and/or allowed origins.

**Auth:** API key via `X-API-Key` header

**Note:** Project name cannot be changed after events have been recorded.

**Request body:**
```json
{
  "name": "new-name",
  "allowed_origins": "https://example.com"
}
```

---

### DELETE /projects/{id}

Soft-delete a project. Revokes the project token.

**Auth:** API key via `X-API-Key` header

**Response:**
```json
{ "ok": true, "deleted": "proj_..." }
```

---

### GET /account

Get your account details, tier, limits, and project count.

**Auth:** API key via `X-API-Key` header

**Response:**
```json
{
  "id": "acc_...",
  "email": "user@example.com",
  "github_login": "username",
  "tier": "free",
  "created_at": "2025-01-01T00:00:00Z",
  "projects_count": 1,
  "projects_limit": 2,
  "tier_limits": {
    "max_projects": 2,
    "max_events_lifetime": 100,
    "retention_days": 7,
    "rate_limit_rpm": 10
  },
  "monthly_spend_cap_dollars": null
}
```

---

### POST /account/revoke-key

Revoke the current API key and generate a new one. The old key stops working immediately.

**Auth:** API key via `X-API-Key` header

**Response:**
```json
{ "ok": true, "api_key": "aak_..." }
```

---

### GET /health

Health check. No auth required.

**Response:**
```json
{ "status": "ok", "service": "agent-analytics" }
```

---

### GET /tracker.js

Returns the lightweight (~2KB) JavaScript tracker. No auth required.

Embed in your HTML:
```html
<script src="https://api.agentanalytics.sh/tracker.js"
        data-project="my-site" data-token="aat_..."></script>
```

Auto-collects: page views, path, URL, hostname, title, referrer, screen size, browser, OS, device type, language, and UTM parameters. No cookies.
